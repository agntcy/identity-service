# Copyright 2025 Cisco Systems, Inc. and its affiliates
# SPDX-License-Identifier: Apache-2.0

---
name: workflow CI/CD
on:
  push:
    branches:
      - "main"
  workflow_dispatch:


permissions:
  id-token: write # This is required for requesting the JWT
  contents: read  # This is required for actions/checkout
  packages: write # needed to push docker image to gar or ecr

jobs:
  ################################## checkout & unit tests ######################
  ###############################################################################
  checkout-unit-tests:
    name: checkout & unit test
    runs-on: ${{ vars.UBUNTU_RUNNER }}
    container:
      image: ${{ vars.SRE_BUILD_IMAGE }}
      options: --user root
      credentials:
        username: ${{ secrets.GHCR_USERNAME }}
        password: ${{ secrets.GHCR_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          # The branch, tag or SHA to checkout, otherwise, uses the default branch.
          ref: ${{ github.ref }}
          # Relative path under $GITHUB_WORKSPACE to place the repository
          path: ''
          # Whether to execute `git clean -ffdx && git reset --hard HEAD` before fetching
          # Default: true
          clean: true
          # Whether to download Git-LFS files
          # Default: false
          lfs: ''
          # Whether to checkout submodules: `true` to checkout submodules or `recursive` to
          # recursively checkout submodules.
          # Default: false
          submodules: ''

      - name: Unit Tests
        run: |
          #chmod +x scripts/unit-test.sh
          bash scripts/unit-test.sh

  ################################## Docker build & push ##########################
  #################################################################################
  call-docker-build-push-backend:
    name: Call Docker Build backend
    needs: [checkout-unit-tests]
    uses: cisco-eti/gh-reusable-workflows/.github/workflows/build-push-docker.yaml@production

    secrets:
      # Only needed if with:ecr-enabled or with:gar-enabled is true below
      vault-approle-role-id: ${{ secrets.VAULT_APPROLE_ROLE_ID }}
      vault-approle-secret-id: ${{ secrets.VAULT_APPROLE_SECRET_ID }}
      ghcr-username: ${{ secrets.GHCR_USERNAME }}
      ghcr-token: ${{ secrets.GHCR_TOKEN }}
      ghcr-org-token: ${{ secrets.GHCR_TOKEN }}

    with:
      runner-group: ${{ vars.DEFAULT_EC2_RUNNER_GROUP }}
      ### REQUIRED
      ### Docker image name
      image-name: "${{ github.event.repository.name }}"

      ### path to where docker should copy files into image
      ### defaults to root of repository (.)
      context: .

      ### Dockerfile alternate name. Default is Dockerfile (relative to context path)
      dockerfile: deployments/docker/backend/Dockerfile.bff
      ### REQUIRED
      ### ENABLE ONE OR BOTH REGISTRIES
      ### tell docker where to push.
      ecr-enabled: true
      artifactory-devhub-enabled: false
      ghcr-enabled: true
      ghcr-org-registry: ${{ vars.GHCR_REGISTRY }}

  call-docker-build-push-mcp-server-currency-exchange:
    name: Call Docker Build mcp server currency exchange
    needs: [checkout-unit-tests]
    uses: cisco-eti/gh-reusable-workflows/.github/workflows/build-push-docker.yaml@production

    secrets:
      # Only needed if with:ecr-enabled or with:gar-enabled is true below
      vault-approle-role-id: ${{ secrets.VAULT_APPROLE_ROLE_ID }}
      vault-approle-secret-id: ${{ secrets.VAULT_APPROLE_SECRET_ID }}
      ghcr-username: ${{ secrets.GHCR_USERNAME }}
      ghcr-token: ${{ secrets.GHCR_TOKEN }}
      ghcr-org-token: ${{ secrets.GHCR_TOKEN }}

    with:
      runner-group: ${{ vars.DEFAULT_EC2_RUNNER_GROUP }}
      ### REQUIRED
      ### Docker image name
      image-name: "${{ github.event.repository.name }}-mcp-server-currency-exchange"

      ### path to where docker should copy files into image
      ### defaults to root of repository (.)
      context: .

      ### Dockerfile alternate name. Default is Dockerfile (relative to context path)
      dockerfile: samples/mcp/currency_exchange/Dockerfile
      ### REQUIRED
      ### ENABLE ONE OR BOTH REGISTRIES
      ### tell docker where to push.
      ecr-enabled: true
      artifactory-devhub-enabled: false
      ghcr-enabled: true
      ghcr-org-registry: ${{ vars.GHCR_REGISTRY }}

  call-docker-build-push-a2a-agent-currency-exchange:
    name: Call Docker Build a2a agent currency exchange
    needs: [checkout-unit-tests]
    uses: cisco-eti/gh-reusable-workflows/.github/workflows/build-push-docker.yaml@production

    secrets:
      # Only needed if with:ecr-enabled or with:gar-enabled is true below
      vault-approle-role-id: ${{ secrets.VAULT_APPROLE_ROLE_ID }}
      vault-approle-secret-id: ${{ secrets.VAULT_APPROLE_SECRET_ID }}
      ghcr-username: ${{ secrets.GHCR_USERNAME }}
      ghcr-token: ${{ secrets.GHCR_TOKEN }}
      ghcr-org-token: ${{ secrets.GHCR_TOKEN }}

    with:
      runner-group: ${{ vars.DEFAULT_EC2_RUNNER_GROUP }}
      ### REQUIRED
      ### Docker image name
      image-name: "${{ github.event.repository.name }}-a2a-agent-currency-exchange"

      ### path to where docker should copy files into image
      ### defaults to root of repository (.)
      context: .

      ### Dockerfile alternate name. Default is Dockerfile (relative to context path)
      dockerfile: samples/agent/a2a/currency_exchange/Dockerfile
      ### REQUIRED
      ### ENABLE ONE OR BOTH REGISTRIES
      ### tell docker where to push.
      ecr-enabled: true
      artifactory-devhub-enabled: false
      ghcr-enabled: true
      ghcr-org-registry: ${{ vars.GHCR_REGISTRY }}

  call-docker-build-push-oasf-agent-financial-assistant:
    name: Call Docker Build oasf agent financial assistant
    needs: [checkout-unit-tests]
    uses: cisco-eti/gh-reusable-workflows/.github/workflows/build-push-docker.yaml@production

    secrets:
      # Only needed if with:ecr-enabled or with:gar-enabled is true below
      vault-approle-role-id: ${{ secrets.VAULT_APPROLE_ROLE_ID }}
      vault-approle-secret-id: ${{ secrets.VAULT_APPROLE_SECRET_ID }}
      ghcr-username: ${{ secrets.GHCR_USERNAME }}
      ghcr-token: ${{ secrets.GHCR_TOKEN }}
      ghcr-org-token: ${{ secrets.GHCR_TOKEN }}

    with:
      runner-group: ${{ vars.DEFAULT_EC2_RUNNER_GROUP }}
      ### REQUIRED
      ### Docker image name
      image-name: "${{ github.event.repository.name }}-oasf-agent-financial-assistant"

      ### path to where docker should copy files into image
      ### defaults to root of repository (.)
      context: .

      ### Dockerfile alternate name. Default is Dockerfile (relative to context path)
      dockerfile: samples/agent/oasf/financial_assistant/Dockerfile
      ### REQUIRED
      ### ENABLE ONE OR BOTH REGISTRIES
      ### tell docker where to push.
      ecr-enabled: true
      artifactory-devhub-enabled: false
      ghcr-enabled: true
      ghcr-org-registry: ${{ vars.GHCR_REGISTRY }}

  call-docker-build-push-ui:
    name: Call Docker Build ui
    needs: [checkout-unit-tests]
    uses: ./.github/workflows/build-push-docker.yaml

    secrets:
      # Only needed if with:ecr-enabled or with:gar-enabled is true below
      vault-approle-role-id: ${{ secrets.VAULT_APPROLE_ROLE_ID }}
      vault-approle-secret-id: ${{ secrets.VAULT_APPROLE_SECRET_ID }}
      ghcr-username: ${{ secrets.GHCR_USERNAME }}
      ghcr-token: ${{ secrets.GHCR_TOKEN }}
      ghcr-org-token: ${{ secrets.GHCR_TOKEN }}
      artifactory_password: ${{ secrets.ARTIFACTORY_PASSWORD }}

    with:
      runner-group: ${{ vars.DEFAULT_EC2_RUNNER_GROUP }}
      ### REQUIRED
      ### Docker image name
      image-name: "${{ github.event.repository.name }}-ui"

      ### path to where docker should copy files into image
      ### defaults to root of repository (.)
      context: .

      ### Dockerfile alternate name. Default is Dockerfile (relative to context path)
      dockerfile: deployments/docker/frontend/Dockerfile
      ### REQUIRED
      ### ENABLE ONE OR BOTH REGISTRIES
      ### tell docker where to push.
      ecr-enabled: true
      artifactory-devhub-enabled: false
      ghcr-enabled: true
      ghcr-org-registry: ${{ vars.GHCR_REGISTRY }}

  call-docker-build-push-docs:
    name: Call Docker Build docs
    needs: [checkout-unit-tests]
    uses: cisco-eti/gh-reusable-workflows/.github/workflows/build-push-docker.yaml@production
    secrets:
      # Only needed if with:ecr-enabled or with:gar-enabled is true below
      vault-approle-role-id: ${{ secrets.VAULT_APPROLE_ROLE_ID }}
      vault-approle-secret-id: ${{ secrets.VAULT_APPROLE_SECRET_ID }}
      ghcr-username: ${{ secrets.GHCR_USERNAME }}
      ghcr-token: ${{ secrets.GHCR_TOKEN }}
      ghcr-org-token: ${{ secrets.GHCR_TOKEN }}
    with:
      runner-group: ${{ vars.DEFAULT_EC2_RUNNER_GROUP }}
      ### REQUIRED
      ### Docker image name
      image-name: "${{ github.event.repository.name }}-docs"

      ### path to where docker should copy files into image
      ### defaults to root of repository (.)
      context: .

      ### Dockerfile alternate name. Default is Dockerfile (relative to context path)
      dockerfile: deployments/docker/docs/Dockerfile
      ### REQUIRED
      ### ENABLE ONE OR BOTH REGISTRIES
      ### tell docker where to push.
      ecr-enabled: true
      artifactory-devhub-enabled: false
      ghcr-enabled: true
      ghcr-org-registry: ${{ vars.GHCR_REGISTRY }}

  # ################################## Helm Publish #################################
  # #################################################################################
  call-helm-publish-backend:
    name: Helm publish Backend
    needs: [checkout-unit-tests]
    uses: cisco-eti/gh-reusable-workflows/.github/workflows/helm-publish.yaml@a663a51a68f4158da24f29d7859dabb891586d5c #main
    with:
      runner-group: ${{ vars.DEFAULT_EC2_RUNNER_GROUP }}
      enable-chartmuseum: true
      enable-private-ecr: false
      enable-public-ecr: false
      chart-path: charts/pyramid-backend
      # override-chart-version: ${{ needs.calculate-tags.outputs.chart_version }}
      #ecr-public-registry-alias: ${{ vars.ECR_PUBLIC_REGISTRY_ALIAS}}
    secrets:
      # GHCR Login for docker build runner
      ghcr-username: ${{ secrets.GHCR_USERNAME }}
      ghcr-token: ${{ secrets.GHCR_TOKEN }}
      vault-approle-role-id: ${{ secrets.VAULT_APPROLE_ROLE_ID }}
      vault-approle-secret-id: ${{ secrets.VAULT_APPROLE_SECRET_ID }}

  call-helm-publish-ui:
    name: Helm publish UI
    needs: [checkout-unit-tests]
    uses: cisco-eti/gh-reusable-workflows/.github/workflows/helm-publish.yaml@a663a51a68f4158da24f29d7859dabb891586d5c #main
    with:
      runner-group: ${{ vars.DEFAULT_EC2_RUNNER_GROUP }}
      enable-chartmuseum: true
      enable-private-ecr: false
      enable-public-ecr: false
      chart-path: charts/pyramid-ui
      # override-chart-version: ${{ needs.calculate-tags.outputs.chart_version }}
      #ecr-public-registry-alias: ${{ vars.ECR_PUBLIC_REGISTRY_ALIAS}}
    secrets:
      # GHCR Login for docker build runner
      ghcr-username: ${{ secrets.GHCR_USERNAME }}
      ghcr-token: ${{ secrets.GHCR_TOKEN }}
      vault-approle-role-id: ${{ secrets.VAULT_APPROLE_ROLE_ID }}
      vault-approle-secret-id: ${{ secrets.VAULT_APPROLE_SECRET_ID }}

  call-helm-publish-docs:
    name: Helm publish Docs
    needs: [checkout-unit-tests]
    uses: cisco-eti/gh-reusable-workflows/.github/workflows/helm-publish.yaml@a663a51a68f4158da24f29d7859dabb891586d5c #main
    with:
      runner-group: ${{ vars.DEFAULT_EC2_RUNNER_GROUP }}
      enable-chartmuseum: true
      enable-private-ecr: false
      enable-public-ecr: false
      chart-path: charts/identity-docs
      # override-chart-version: ${{ needs.calculate-tags.outputs.chart_version }}
      #ecr-public-registry-alias: ${{ vars.ECR_PUBLIC_REGISTRY_ALIAS}}
    secrets:
      # GHCR Login for docker build runner
      ghcr-username: ${{ secrets.GHCR_USERNAME }}
      ghcr-token: ${{ secrets.GHCR_TOKEN }}
      vault-approle-role-id: ${{ secrets.VAULT_APPROLE_ROLE_ID }}
      vault-approle-secret-id: ${{ secrets.VAULT_APPROLE_SECRET_ID }}

  call-helm-publish-mcp-server-currency-exchange:
    name: Helm publish mcp-server-currency-exchange
    needs: [checkout-unit-tests]
    uses: cisco-eti/gh-reusable-workflows/.github/workflows/helm-publish.yaml@a663a51a68f4158da24f29d7859dabb891586d5c #main
    with:
      runner-group: ${{ vars.DEFAULT_EC2_RUNNER_GROUP }}
      enable-chartmuseum: true
      enable-private-ecr: false
      enable-public-ecr: false
      chart-path: charts/samples/identity-sample-currency-exchange-mcp
      # override-chart-version: ${{ needs.calculate-tags.outputs.chart_version }}
      #ecr-public-registry-alias: ${{ vars.ECR_PUBLIC_REGISTRY_ALIAS}}
    secrets:
      # GHCR Login for docker build runner
      ghcr-username: ${{ secrets.GHCR_USERNAME }}
      ghcr-token: ${{ secrets.GHCR_TOKEN }}
      vault-approle-role-id: ${{ secrets.VAULT_APPROLE_ROLE_ID }}
      vault-approle-secret-id: ${{ secrets.VAULT_APPROLE_SECRET_ID }}

  call-helm-publish-identity-sample-currency-exchange-a2a:
    name: Helm publish identity-sample-currency-exchange-a2a
    needs: [checkout-unit-tests]
    uses: cisco-eti/gh-reusable-workflows/.github/workflows/helm-publish.yaml@a663a51a68f4158da24f29d7859dabb891586d5c #main
    with:
      runner-group: ${{ vars.DEFAULT_EC2_RUNNER_GROUP }}
      enable-chartmuseum: true
      enable-private-ecr: false
      enable-public-ecr: false
      chart-path: charts/samples/identity-sample-currency-exchange-a2a
      # override-chart-version: ${{ needs.calculate-tags.outputs.chart_version }}
      #ecr-public-registry-alias: ${{ vars.ECR_PUBLIC_REGISTRY_ALIAS}}
    secrets:
      # GHCR Login for docker build runner
      ghcr-username: ${{ secrets.GHCR_USERNAME }}
      ghcr-token: ${{ secrets.GHCR_TOKEN }}
      vault-approle-role-id: ${{ secrets.VAULT_APPROLE_ROLE_ID }}
      vault-approle-secret-id: ${{ secrets.VAULT_APPROLE_SECRET_ID }}

  call-helm-publish-identity-sample-financial-assist-oasf:
    name: Helm publish identity-sample-financial-assist-oasf
    needs: [checkout-unit-tests]
    uses: cisco-eti/gh-reusable-workflows/.github/workflows/helm-publish.yaml@a663a51a68f4158da24f29d7859dabb891586d5c #main
    with:
      runner-group: ${{ vars.DEFAULT_EC2_RUNNER_GROUP }}
      enable-chartmuseum: true
      enable-private-ecr: false
      enable-public-ecr: false
      chart-path: charts/samples/identity-sample-financial-assist-oasf
      # override-chart-version: ${{ needs.calculate-tags.outputs.chart_version }}
      #ecr-public-registry-alias: ${{ vars.ECR_PUBLIC_REGISTRY_ALIAS}}
    secrets:
      # GHCR Login for docker build runner
      ghcr-username: ${{ secrets.GHCR_USERNAME }}
      ghcr-token: ${{ secrets.GHCR_TOKEN }}
      vault-approle-role-id: ${{ secrets.VAULT_APPROLE_ROLE_ID }}
      vault-approle-secret-id: ${{ secrets.VAULT_APPROLE_SECRET_ID }}

  ################################## Trigger Deployment ###########################
  #################################################################################

  # UI Deployment
  call-trigger-cd-ui:
    name: Trigger CD UI
    needs: [call-docker-build-push-ui, call-helm-publish-ui]
    uses: cisco-eti/gh-reusable-workflows/.github/workflows/trigger-deploy.yaml@production
    with:
      deployment-repo: "cisco-eti/pyramid-deployment"
      client-payload: '{"app-repository": "${{ github.repository }}", "values-file-path": "applications/identity-pyramid-ui", "property-path": "image.tag", "deployment-stage": "dev", "default-deployment": true, "value": ""}'
    secrets:
      ghcr-username: ${{ secrets.GHCR_USERNAME }}
      ghcr-token: ${{ secrets.GHCR_TOKEN }}
      ghcr-org-username: ${{ secrets.GHCR_USERNAME }}
      ghcr-org-token: ${{ secrets.GHCR_TOKEN }}
      vault-approle-role-id: ${{ secrets.VAULT_APPROLE_ROLE_ID }}
      vault-approle-secret-id: ${{ secrets.VAULT_APPROLE_SECRET_ID }}

  # Backend Deployment
  call-trigger-cd-backend:
    name: Trigger CD Backend
    needs: [call-docker-build-push-backend, call-helm-publish-backend]
    uses: cisco-eti/gh-reusable-workflows/.github/workflows/trigger-deploy.yaml@production
    with:
      deployment-repo: "cisco-eti/pyramid-deployment"
      client-payload: '{"app-repository": "${{ github.repository }}", "values-file-path": "applications/identity-pyramid-backend", "property-path": "image.tag", "deployment-stage": "dev", "default-deployment": true, "value": ""}'
    secrets:
      ghcr-username: ${{ secrets.GHCR_USERNAME }}
      ghcr-token: ${{ secrets.GHCR_TOKEN }}
      ghcr-org-username: ${{ secrets.GHCR_USERNAME }}
      ghcr-org-token: ${{ secrets.GHCR_TOKEN }}
      vault-approle-role-id: ${{ secrets.VAULT_APPROLE_ROLE_ID }}
      vault-approle-secret-id: ${{ secrets.VAULT_APPROLE_SECRET_ID }}

  # Docs Deployment
  call-trigger-cd-docs:
    name: Trigger CD Docs
    needs: [call-docker-build-push-docs, call-helm-publish-docs]
    uses: cisco-eti/gh-reusable-workflows/.github/workflows/trigger-deploy.yaml@production
    with:
      deployment-repo: "cisco-eti/pyramid-deployment"
      client-payload: '{"app-repository": "${{ github.repository }}", "values-file-path": "applications/identity-docs", "property-path": "image.tag", "deployment-stage": "dev", "default-deployment": true, "value": ""}'
    secrets:
      ghcr-username: ${{ secrets.GHCR_USERNAME }}
      ghcr-token: ${{ secrets.GHCR_TOKEN }}
      ghcr-org-username: ${{ secrets.GHCR_USERNAME }}
      ghcr-org-token: ${{ secrets.GHCR_TOKEN }}
      vault-approle-role-id: ${{ secrets.VAULT_APPROLE_ROLE_ID }}
      vault-approle-secret-id: ${{ secrets.VAULT_APPROLE_SECRET_ID }}

  # MCP Server Currency Exchange Deployment
  call-trigger-cd-mcp-server-currency-exchange:
    name: Trigger CD MCP Server Currency Exchange
    needs: [call-docker-build-push-mcp-server-currency-exchange, call-helm-publish-mcp-server-currency-exchange]
    uses: cisco-eti/gh-reusable-workflows/.github/workflows/trigger-deploy.yaml@production
    with:
      deployment-repo: "cisco-eti/pyramid-deployment"
      client-payload: '{"app-repository": "${{ github.repository }}", "values-file-path": "applications/identity-sample-currency-exchange-mcp", "property-path": "image.tag", "deployment-stage": "dev", "default-deployment": true, "value": ""}'
    secrets:
      ghcr-username: ${{ secrets.GHCR_USERNAME }}
      ghcr-token: ${{ secrets.GHCR_TOKEN }}
      ghcr-org-username: ${{ secrets.GHCR_USERNAME }}
      ghcr-org-token: ${{ secrets.GHCR_TOKEN }}
      vault-approle-role-id: ${{ secrets.VAULT_APPROLE_ROLE_ID }}
      vault-approle-secret-id: ${{ secrets.VAULT_APPROLE_SECRET_ID }}

  # A2A Agent Currency Exchange Deployment
  call-trigger-cd-a2a-agent-currency-exchange:
    name: Trigger CD A2A Agent Currency Exchange
    needs: [call-docker-build-push-a2a-agent-currency-exchange, call-helm-publish-identity-sample-currency-exchange-a2a]
    uses: cisco-eti/gh-reusable-workflows/.github/workflows/trigger-deploy.yaml@production
    with:
      deployment-repo: "cisco-eti/pyramid-deployment"
      client-payload: '{"app-repository": "${{ github.repository }}", "values-file-path": "applications/identity-sample-currency-exchange-a2a", "property-path": "image.tag", "deployment-stage": "dev", "default-deployment": true, "value": ""}'
    secrets:
      ghcr-username: ${{ secrets.GHCR_USERNAME }}
      ghcr-token: ${{ secrets.GHCR_TOKEN }}
      ghcr-org-username: ${{ secrets.GHCR_USERNAME }}
      ghcr-org-token: ${{ secrets.GHCR_TOKEN }}
      vault-approle-role-id: ${{ secrets.VAULT_APPROLE_ROLE_ID }}
      vault-approle-secret-id: ${{ secrets.VAULT_APPROLE_SECRET_ID }}

  # OASF Agent Financial Assistant Deployment
  call-trigger-cd-oasf-agent-financial-assistant:
    name: Trigger CD oasf Agent financial assistant
    needs: [call-docker-build-push-oasf-agent-financial-assistant, call-helm-publish-identity-sample-financial-assist-oasf]
    uses: cisco-eti/gh-reusable-workflows/.github/workflows/trigger-deploy.yaml@production
    with:
      deployment-repo: "cisco-eti/pyramid-deployment"
      client-payload: '{"app-repository": "${{ github.repository }}", "values-file-path": "applications/identity-sample-financial-assist-oasf", "property-path": "image.tag", "deployment-stage": "dev", "default-deployment": true, "value": ""}'
    secrets:
      ghcr-username: ${{ secrets.GHCR_USERNAME }}
      ghcr-token: ${{ secrets.GHCR_TOKEN }}
      ghcr-org-username: ${{ secrets.GHCR_USERNAME }}
      ghcr-org-token: ${{ secrets.GHCR_TOKEN }}
      vault-approle-role-id: ${{ secrets.VAULT_APPROLE_ROLE_ID }}
      vault-approle-secret-id: ${{ secrets.VAULT_APPROLE_SECRET_ID }}
