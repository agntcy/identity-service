# Testing

At this stage, the Agent Identity Service includes only unit tests.

Only pull requests with passing unit tests are merged.

## Unit tests

- Required for every file where unit testing is practical.
- Place the test file next to the file being tested.
  - If no private functions/methods are being tested, add the suffix `_test` to the package name for the test (e.g., `auth_test`).
  - Otherwise, use the same package name as the file under test.
- Avoid introducing infrastructure dependencies.
- One test function per function/method.
  - Prefer [table-driven tests](https://go.dev/wiki/TableDrivenTests) for multiple inputs or scenarios.
  - If table-driven tests aren't suitable:
    - Create one test function per test case, or
    - Use [`T.Run()`](https://pkg.go.dev/testing#T.Run) to create subtests within the same function.
- Arrange the body of the test using the "*Arrage -> Act -> Assert*" pattern:
  - **Arrange** your objects, data, and set them up as necessary.
  - **Act** on the code under test by executing it.
  - **Assert** the result based on what is expected.
  ```go
  func TestAppService_CreateApp_should_succeed(t *testing.T) {
    t.Parallel()

    // Arrange
    var (
      app apptypes.App
      req identity_service_sdk_go.CreateAppRequest
    )

    _ = gofakeit.Struct(&app)
    _ = gofakeit.Struct(&req)

    appSrv := bffmocks.NewAppService(t)
    appSrv.EXPECT().CreateApp(t.Context(), mock.Anything).Return(&app, nil)

    sut := grpc.NewAppService(appSrv, nil) // sut: system under test

    // Act
    actual, err := sut.CreateApp(t.Context(), &req)

    // Assert
    assert.NoError(t, err)
    assert.NotNil(t, actual)
  }
  ```
- Append `t.Parallel()` to the test when tests can safely run concurrently.

### Naming convention

#### Test functions with a single scenario

When a test function covers a single scenario, its name should be composed of four parts:

1. **Struct name** - *(incude only if testing a struct method; omit for standalone functions)*.
2. **Function/method name** - The specific function or method being tested.
3. **Expected behavior** - The outcome expected when the scenario is invoked, prefer the use of the verb `should`.
4. **Test scenario** - The specific condition or context in which the function/method is being tested.

For example:

```go
// Testing a method
func TestAppService_CreateApp_should_return_err_when_idp_type_is_invalid(t *testing.T)   

// Testing a function
func TestVerify_should_pass_when_jwt_has_invalid_signature(t *testing.T)
```

#### Test functions with subtests

When a test function contains multiple subtests, the function name should include only:

1. **Struct name + method name** (if testing a method), or
2. **Function name** (if testing a standalone function).

For example:

```go
// Testing a method
func TestSettingsService_SetApiKey(t *testing.T)

// Testing a function
func TestIsDomainError(t *testing.T)
```

#### Subtest naming

Subtest names should be written as a clear, descriptive sentence that explains both the scenario being tested and the expected behavior.

For example:

```go
func TestSettingsService_SetApiKey(t *testing.T) {
  t.Run("should set a API key for a tenant when it doesn't have one yet", func(t *testing.T) {
    // ...
  })

  t.Run("should revoke an existing API key for the tenant before creating a new one", func(t *testing.T) {
    // ...
	})
}
```

### Assertion

All test assertions are done using the `testify` library. For more information, see the official documentation: https://github.com/stretchr/testify.

### Mocks

[Mocks](https://en.wikipedia.org/wiki/Mock_object) are generated using the [`mockery`](https://vektra.github.io/mockery/latest/) tool. To specify which interfaces should be mocked, list them explicitly in the [`.mockery.yaml`](https://github.com/agntcy/identity-service/blob/main/backend/.mockery.yaml) configuration file.

Running `make generate_mocks` will generate all the mocks for the configured interfaces.
By default, each mock object is placed in a `mocks` package within the package of its corresponding interface.

Under the hood, the mocks generated by `mockery` utilize the `mock` package of `github.com/stretchr/testify`.

**Usage example**

```go
import (
  policymocks "github.com/agntcy/identity-service/internal/core/policy/mocks"
  // ...
)

func TestSomeTest(t *testing.T) {
  // ...

  policyRepo := policymocks.NewPolicyRepository(t)
  policyRepo.EXPECT().GetByID(ctx, policy.ID).Return(policy, nil)

  // ..
}
```

### Run all unit tests

You can run the tests with `go test`.

```sh
cd backend

# Run all unit tests
go test ./...
```

Since the tests may run concurrently, run the tests multiple times to make sure no race condition is affecting the results:

```sh
# Run each test 5 times
go test ./... -count 5
```

### Test coverage

You can run coverage analysis using the `-cover` argument:

```sh
go test ./... -cover
```
